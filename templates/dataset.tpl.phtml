<?php include( "templates/controls.tpl.phtml" ); ?>
<script>
	var checkDevices = function() {
		$( "#dev" ).val( "" );

		$.ajax({
			url: "index.php",
			data: { action: "check" }
		}).done( function( response ) {
			var deviceList = [];

			// TODO: consider more than one connected device
			$.each( $.parseJSON( response ), function( index, value ) {
				deviceList.push( "<li>USB storage device connected: " + value + "</li>" );
				$( "#dev" ).val( value );
			});

			// TODO: remove test output
			$( "#deviceList" ).html( "<ul>" + deviceList.join() + "</ul>" );
			//

			// disable download button if no storage device connected
			$( "#btnDownload" ).attr( "disabled", $( "#dev" ).val() !== "" ? false : "disabled" );
		});
	}
</script>
	<div class="row">
		<div class="col-md-12">
			<h1><?php echo $this->_setTitle; ?></h1>
			<p class="setShort"><?php echo nl2br( $this->_dataSet["ShortDescription"][0] ); ?></p>
		</div>
		<div class="col-md-8 tile" style="padding: 20px;">
			<div class="setInfo">
				<?php $this->includeMediaPreview(); ?>
				<?php echo nl2br( $this->_dataSet["LongDescription"][0] ); ?>
			</div>
			<div style="clear: both;"></div>
		</div>
		<div class="col-md-4">
			<div class="infoBox tile">
				<h4>Autor</h4>
				<p><?php echo $this->_dataSet["Author"][0]; ?></p>
				<h4>Supplier</h4>
				<p><?php echo $this->_dataSet["Supplier"][0]; ?></p>
				<h4>Lizenz</h4>
				<p><?php echo $this->_dataSet["Licence"][0]; ?></p>

				<?php if ( !$this->isLocalSystem() ): ?>
				<div id="dlDisabled">
					<p style="text-align: center;">
						Speichermedium anschlie&szlig;en zum Herunterladen dieses Datensets<br />
					</p>
				</div>
				
				<div id="dlEnabled" style="display: none;">
					<form name="dlForm" method="GET">
						<input type="hidden" name="action" id="action" value="download" />
						<input type="hidden" name="subject" id="subject" value="<?php echo html_entity_decode( $this->_setTitle ); ?>" />
						<input type="hidden" name="dev" id="dev" value="" />
						<div style="text-align: center;">
							<button type="button" id="btnDownload" disabled="disabled" class="btn btn-lg">Herunterladen</button>
						</div>
					</form>
				</div>
				<script>
					$( document ).ready( function() {
						window.setInterval( checkDevices, 2000 );
					});
				</script>
				<?php else: ?>
				<div style="text-align: center;">
					<form name="dlForm" method="GET" action="downloads/<?php echo @$this->_dataSet["FileName"][0]; ?>">
						<button type="submit" id="btnDownload" class="btn btn-lg">Herunterladen</button>
					</form>
				</div>
				<?php endif; ?>
			</ul>
		</div>
	</div>
